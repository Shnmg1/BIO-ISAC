<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incident Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="../styles/main.css">
    <style>
        /* BIO-ISAC Color Scheme - Professional Green Theme */
        /* Colors inspired by BIO-ISAC website: dark and light green palette */
        :root {
            --bio-primary-green: #1e4d2b;
            --bio-dark-green: #0f2817;
            --bio-medium-green: #2d6a3f;
            --bio-light-green: #4aad6a;
            --bio-bright-green: #6bcf8f;
            --bio-accent-green: #3d8a56;
            --bio-text-light: #f0f9f4;
        }

        /* Logo styling */
        .bio-isac-logo {
            height: 64.69px;
            width: auto;
            max-width: 288px;
            object-fit: contain;
            margin-top: 20px;
        }

        /* Update header bar to match BIO-ISAC theme */
        .header-bar {
            background: #000000;
            border-bottom: none;
            position: relative;
            justify-content: space-between;
            align-items: flex-start;
            padding: 0 20px 5px 20px;
            min-height: 95px;
        }

        /* Change all gray backgrounds to flat black */
        body {
            background-color: #000000 !important;
        }

        .main-container {
            background-color: #000000;
        }

        .sidebar {
            background-color: #000000;
            border-right: 1px solid var(--bio-light-green);
        }

        .main-content {
            background-color: #000000;
        }

        .content-section {
            background-color: #000000;
        }

        .incident-queue {
            background-color: #000000;
            border-top: 1px solid var(--bio-light-green);
        }

        /* Ensure text remains visible on black background */
        .section-title,
        .form-label,
        .inbox-title,
        .inbox-date,
        .message-contact-name,
        .message-contact-phone,
        .queue-header,
        .queue-table {
            color: var(--bio-text-light);
        }

        /* Form controls */
        .form-control {
            background-color: #000000;
            border: 1px solid var(--bio-light-green);
            color: var(--bio-text-light);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--bio-bright-green);
        }

        .textarea {
            background-color: #000000;
            border: 1px solid var(--bio-light-green);
            color: var(--bio-text-light);
        }

        .textarea:focus {
            outline: none;
            border-color: var(--bio-bright-green);
        }

        /* Buttons */
        .btn-primary {
            background-color: var(--bio-bright-green);
            color: var(--bio-primary-green);
            border: none;
        }

        .btn-primary:hover {
            background-color: var(--bio-light-green);
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--bio-light-green);
            color: var(--bio-text-light);
        }

        .btn-outline:hover {
            background-color: rgba(74, 173, 106, 0.1);
            border-color: var(--bio-bright-green);
        }

        /* Radio buttons and checkboxes */
        .radio-option label,
        .checkbox-item label {
            color: var(--bio-text-light);
        }

        /* Inbox items */
        .inbox-item {
            border-bottom: 1px solid var(--bio-medium-green);
        }

        .inbox-item:hover {
            background-color: rgba(74, 173, 106, 0.1);
        }

        /* Message bubbles */
        .message-bubble {
            background-color: var(--bio-medium-green);
            color: var(--bio-text-light);
        }

        .message-sent {
            background-color: var(--bio-bright-green);
            color: var(--bio-primary-green);
        }

        /* Queue table */
        .queue-table {
            border-color: var(--bio-light-green);
        }

        .queue-table th,
        .queue-table td {
            border-color: var(--bio-light-green);
        }

        /* Status colors */
        .status-created {
            background-color: var(--bio-bright-green);
        }

        .status-dispatched {
            background-color: var(--bio-light-green);
        }

        .status-onscene {
            background-color: #ffaa00;
        }

        .status-closed {
            background-color: var(--bio-medium-green);
        }

        /* Icon buttons */
        .icon-btn-small {
            color: var(--bio-text-light);
        }

        .icon-btn-small:hover {
            color: var(--bio-bright-green);
        }

        /* Send button */
        .send-btn {
            background-color: var(--bio-bright-green);
            color: var(--bio-primary-green);
        }

        .send-btn:hover {
            background-color: var(--bio-light-green);
        }

        /* Message input */
        .message-input {
            background-color: #000000;
            border: 1px solid var(--bio-light-green);
            color: var(--bio-text-light);
        }

        .message-input:focus {
            outline: none;
            border-color: var(--bio-bright-green);
        }

        /* Queue controls */
        .queue-controls button {
            color: var(--bio-text-light);
        }

        .queue-controls button:hover {
            color: var(--bio-bright-green);
        }

        /* Resize handles */
        .resize-handle {
            background-color: var(--bio-medium-green);
        }

        .resize-handle:hover {
            background-color: var(--bio-light-green);
        }

        /* Settings Dropdown Styles */
        .header-icons {
            margin-top: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .settings-container {
            position: relative;
        }

        .settings-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 10px;
            background-color: #000000;
            border: 1px solid var(--bio-light-green);
            border-radius: 6px;
            min-width: 220px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow: hidden;
        }

        .settings-dropdown.active {
            display: block;
        }

        .settings-dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            color: var(--bio-text-light);
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid var(--bio-medium-green);
        }

        .settings-dropdown-item:last-child {
            border-bottom: none;
        }

        .settings-dropdown-item:hover {
            background-color: rgba(74, 173, 106, 0.2);
        }

        .settings-dropdown-item i {
            width: 20px;
            color: var(--bio-bright-green);
        }

        .settings-dropdown-item span {
            flex: 1;
        }

        .config-btn {
            color: var(--bio-text-light);
            font-size: 18px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }

        .config-btn:hover {
            color: var(--bio-bright-green);
        }

        .settings-dropdown-divider {
            height: 1px;
            background-color: var(--bio-medium-green);
            margin: 4px 0;
        }

        /* Accessibility Modal Styles */
        .accessibility-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .accessibility-modal.active {
            display: flex;
        }

        .accessibility-modal-content {
            background-color: #000000;
            border: 1px solid var(--bio-light-green);
            border-radius: 8px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .accessibility-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--bio-medium-green);
        }

        .accessibility-modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--bio-text-light);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .accessibility-modal-title i {
            color: var(--bio-bright-green);
        }

        .accessibility-modal-close {
            background: none;
            border: none;
            color: var(--bio-text-light);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }

        .accessibility-modal-close:hover {
            color: var(--bio-bright-green);
        }

        .accessibility-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .accessibility-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background-color: rgba(74, 173, 106, 0.05);
            border: 1px solid var(--bio-medium-green);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .accessibility-option:hover {
            background-color: rgba(74, 173, 106, 0.15);
            border-color: var(--bio-light-green);
        }

        .accessibility-option.selected {
            background-color: rgba(74, 173, 106, 0.2);
            border-color: var(--bio-bright-green);
        }

        .accessibility-option input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--bio-bright-green);
            margin: 0;
        }

        .accessibility-option-label {
            flex: 1;
            color: var(--bio-text-light);
            cursor: pointer;
            font-size: 14px;
        }

        .accessibility-option-description {
            font-size: 12px;
            color: var(--bio-text-light);
            opacity: 0.7;
            margin-top: 4px;
        }

        .alert-modal-value.readonly {
            background-color: rgba(74, 173, 106, 0.05);
            opacity: 0.8;
            border: 1px solid var(--bio-medium-green);
            padding: 10px 12px;
            border-radius: 4px;
            min-height: 20px;
        }

        /* Alert Modal Styles */
        .alert-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .alert-modal.active {
            display: flex;
        }

        .alert-modal-content {
            background-color: #000000;
            border: 2px solid var(--bio-light-green);
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            position: relative;
        }

        .alert-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--bio-light-green);
        }

        .alert-modal-header h2 {
            color: var(--bio-text-light);
            font-size: 24px;
            font-weight: 600;
            margin: 0;
        }

        .alert-modal-close {
            background: none;
            border: none;
            color: var(--bio-text-light);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .alert-modal-close:hover {
            background-color: rgba(74, 173, 106, 0.2);
            color: var(--bio-bright-green);
        }

        .alert-modal-body {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .alert-modal-field {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .alert-modal-label {
            color: var(--bio-text-light);
            font-size: 13px;
            font-weight: 600;
            opacity: 0.9;
        }

        .alert-modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--bio-light-green);
            flex-wrap: wrap;
        }

        .alert-modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .alert-modal-btn-primary {
            background-color: var(--bio-bright-green);
            color: var(--bio-primary-green);
        }

        .alert-modal-btn-primary:hover {
            background-color: var(--bio-light-green);
        }

        .alert-modal-btn-outline {
            background-color: transparent;
            border: 1px solid var(--bio-light-green);
            color: var(--bio-text-light);
        }

        .alert-modal-btn-outline:hover {
            background-color: rgba(74, 173, 106, 0.1);
            border-color: var(--bio-bright-green);
        }

        .alert-modal select,
        .alert-modal input[type="text"],
        .alert-modal textarea,
        .alert-modal .form-control {
            color: #ffffff !important;
            background-color: #000000 !important;
        }

        .alert-modal select option {
            background-color: #000000;
            color: #ffffff;
        }

        /* Next Steps Modal */
        .next-steps-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .next-steps-modal.active {
            display: flex;
        }

        .next-steps-modal-content {
            background-color: #000000;
            border: 2px solid var(--bio-light-green);
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            position: relative;
        }

        .next-steps-list {
            list-style: none;
            padding: 0;
            margin: 15px 0;
        }

        .next-steps-list li {
            padding: 10px 15px;
            margin: 8px 0;
            background-color: rgba(74, 173, 106, 0.1);
            border-left: 3px solid var(--bio-bright-green);
            color: var(--bio-text-light);
            border-radius: 4px;
        }

        .next-steps-list li:before {
            content: "â†’ ";
            color: var(--bio-bright-green);
            font-weight: bold;
        }

        .queue-table tbody tr {
            cursor: pointer;
        }

        .queue-table tbody tr:hover {
            background-color: rgba(74, 173, 106, 0.1);
        }

        .tier-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .tier-high {
            background-color: #ff4444;
            color: #ffffff;
        }

        .tier-medium {
            background-color: #ffaa00;
            color: #000000;
        }

        .tier-low {
            background-color: var(--bio-bright-green);
            color: var(--bio-primary-green);
        }
    </style>
</head>
<body class="dashboard-body">
    <div class="header-bar dashboard">
        <div class="logo-section">
            <img src="../images/image.png" alt="BIO-ISAC Logo" class="bio-isac-logo">
        </div>
        <div class="header-icons">
            <div class="settings-container">
                <button class="config-btn" id="settingsBtn"><i class="fas fa-cog"></i></button>
                <div class="settings-dropdown" id="settingsDropdown">
                    <div class="settings-dropdown-item" id="accountSettingsMenuItem">
                        <i class="fas fa-user-cog"></i>
                        <span>Account Settings</span>
                    </div>
                    <div class="settings-dropdown-divider"></div>
                    <div class="settings-dropdown-item" id="accessibilityMenuItem">
                        <i class="fas fa-universal-access"></i>
                        <span>Accessibility</span>
                    </div>
                </div>
            </div>
            <button class="config-btn" id="logoutBtn" title="Logout">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
    </div>

    <div class="main-container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-controls-header">
                <button class="icon-btn-small"><i class="fas fa-search"></i></button>
                <button class="icon-btn-small"><i class="fas fa-filter"></i></button>
                <button class="icon-btn-small traffic-light">
                    <span class="traffic-dot" style="background: #ff4444;"></span>
                    <span class="traffic-dot" style="background: #ffaa00;"></span>
                    <span class="traffic-dot" style="background: #71b53f;"></span>
                    <i class="fas fa-caret-down" style="font-size: 10px; margin-left: 4px;"></i>
                </button>
                <button class="icon-btn-small plus-btn"><i class="fas fa-plus"></i></button>
            </div>
            <div class="sidebar-content inbox-list" id="inboxList">
                <!-- Messages will be loaded from database -->
            </div>
            
            <div class="message-view" id="messageView" style="display: none;">
                <div class="message-header">
                    <button class="back-btn" id="backBtn">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="message-contact-info">
                        <div class="message-contact-name" id="messageContactName"></div>
                        <div class="message-contact-phone" id="messageContactPhone"></div>
                    </div>
                </div>
                <div class="message-content" id="messageContent">
                    <!-- Messages will be displayed here -->
                </div>
                <div class="message-input-area">
                    <input type="text" class="message-input" id="messageInput" placeholder="Type a message...">
                    <button class="send-btn" id="sendBtn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Account Settings Modal -->
        <div class="alert-modal" id="accountSettingsModal">
            <div class="alert-modal-content" style="max-width: 600px;">
                <div class="alert-modal-header">
                    <h2><i class="fas fa-user-cog"></i> Account Settings</h2>
                    <button class="alert-modal-close" id="closeAccountSettingsModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="alert-modal-body">
                    <form id="accountSettingsForm">
                        <div class="alert-modal-field">
                            <label class="alert-modal-label">Full Name</label>
                            <div class="alert-modal-value readonly" id="accountFullName"></div>
                        </div>
                        <div class="alert-modal-field">
                            <label class="alert-modal-label">Email</label>
                            <div class="alert-modal-value readonly" id="accountEmail"></div>
                        </div>
                        <div class="alert-modal-field">
                            <label class="alert-modal-label">Facility Name</label>
                            <div class="alert-modal-value readonly" id="accountFacilityName"></div>
                        </div>
                        <div class="alert-modal-field">
                            <label class="alert-modal-label">Industry / Facility Type</label>
                            <select class="form-control" id="accountFacilityType" style="width: 100%; padding: 8px; margin-top: 5px; color: #ffffff; background-color: #000000;">
                                <option value="Hospital" style="background-color: #000000; color: #ffffff;">Hospital</option>
                                <option value="Lab" style="background-color: #000000; color: #ffffff;">Lab</option>
                                <option value="Biomanufacturing" style="background-color: #000000; color: #ffffff;">Biomanufacturing</option>
                                <option value="Agriculture" style="background-color: #000000; color: #ffffff;">Agriculture</option>
                                <option value="Biotechnology" style="background-color: #000000; color: #ffffff;">Biotechnology</option>
                                <option value="Life Sciences" style="background-color: #000000; color: #ffffff;">Life Sciences</option>
                                <option value="Research Laboratory" style="background-color: #000000; color: #ffffff;">Research Laboratory</option>
                                <option value="Manufacturing / Supply Chain" style="background-color: #000000; color: #ffffff;">Manufacturing / Supply Chain</option>
                                <option value="Healthcare / Clinical Data" style="background-color: #000000; color: #ffffff;">Healthcare / Clinical Data</option>
                                <option value="Other" style="background-color: #000000; color: #ffffff;">Other</option>
                            </select>
                        </div>
                        <div class="alert-modal-field">
                            <label class="alert-modal-label">Contact Information</label>
                            <input type="text" class="form-control" id="accountContactInfo" placeholder="Phone number or contact info" style="width: 100%; padding: 8px; margin-top: 5px; color: #ffffff; background-color: #000000;">
                            <small style="color: #999; font-size: 12px; margin-top: 5px; display: block;">Optional: Add your contact information</small>
                        </div>
                        
                        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--bio-medium-green);">
                            <h3 style="font-size: 16px; margin-bottom: 15px; color: var(--bio-text-light);">Notification Preferences</h3>
                            
                            <div class="alert-modal-field">
                                <label class="alert-modal-label">Delivery Mode</label>
                                <select class="form-control" id="notificationDeliveryMode" style="width: 100%; padding: 8px; margin-top: 5px; color: #ffffff; background-color: #000000;">
                                    <option value="Immediate" style="background-color: #000000; color: #ffffff;">Immediate</option>
                                    <option value="DailyDigest" style="background-color: #000000; color: #ffffff;">Daily Digest</option>
                                    <option value="WeeklyDigest" style="background-color: #000000; color: #ffffff;">Weekly Digest</option>
                                </select>
                            </div>
                            
                            <div class="alert-modal-field" id="dailyDigestTimeField" style="display: none;">
                                <label class="alert-modal-label">Daily Digest Time</label>
                                <input type="time" class="form-control" id="dailyDigestTime" style="width: 100%; padding: 8px; margin-top: 5px; color: #ffffff; background-color: #000000;">
                            </div>
                            
                            <div class="alert-modal-field" id="weeklyDigestDayField" style="display: none;">
                                <label class="alert-modal-label">Weekly Digest Day</label>
                                <select class="form-control" id="weeklyDigestDay" style="width: 100%; padding: 8px; margin-top: 5px; color: #ffffff; background-color: #000000;">
                                    <option value="Monday" style="background-color: #000000; color: #ffffff;">Monday</option>
                                    <option value="Tuesday" style="background-color: #000000; color: #ffffff;">Tuesday</option>
                                    <option value="Wednesday" style="background-color: #000000; color: #ffffff;">Wednesday</option>
                                    <option value="Thursday" style="background-color: #000000; color: #ffffff;">Thursday</option>
                                    <option value="Friday" style="background-color: #000000; color: #ffffff;">Friday</option>
                                    <option value="Saturday" style="background-color: #000000; color: #ffffff;">Saturday</option>
                                    <option value="Sunday" style="background-color: #000000; color: #ffffff;">Sunday</option>
                                </select>
                            </div>
                            
                            <div class="alert-modal-field">
                                <label style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                                    <input type="checkbox" id="receiveHighTier" style="width: 18px; height: 18px;">
                                    <span>Receive High Tier Alerts</span>
                                </label>
                            </div>
                            <div class="alert-modal-field">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="receiveMediumTier" style="width: 18px; height: 18px;">
                                    <span>Receive Medium Tier Alerts</span>
                                </label>
                            </div>
                            <div class="alert-modal-field">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="receiveLowTier" style="width: 18px; height: 18px;">
                                    <span>Receive Low Tier Alerts</span>
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="alert-modal-actions">
                    <button class="alert-modal-btn alert-modal-btn-primary" id="saveAccountSettingsBtn">
                        <i class="fas fa-save"></i>
                        Save Changes
                    </button>
                    <button class="alert-modal-btn alert-modal-btn-outline" id="cancelAccountSettingsBtn">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- New Conversation Modal -->
        <div class="alert-modal" id="newConversationModal">
            <div class="alert-modal-content">
                <div class="alert-modal-header">
                    <h2><i class="fas fa-plus"></i> New Conversation</h2>
                    <button class="alert-modal-close" id="closeNewConversationModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="alert-modal-body">
                    <form id="newConversationForm">
                        <div class="alert-modal-field">
                            <label class="alert-modal-label">Subject</label>
                            <input type="text" class="form-control" id="newConversationSubject" placeholder="Enter subject..." required style="width: 100%; padding: 8px; margin-top: 5px;">
                        </div>
                        <div class="alert-modal-field">
                            <label class="alert-modal-label">Message</label>
                            <textarea class="form-control" id="newConversationMessage" placeholder="Enter your message..." rows="5" required style="width: 100%; padding: 8px; margin-top: 5px; resize: vertical;"></textarea>
                        </div>
                        <div style="margin-top: 10px; padding: 12px; background-color: rgba(74, 173, 106, 0.1); border: 1px solid var(--bio-light-green); border-radius: 4px;">
                            <div style="display: flex; align-items: center; gap: 8px; color: var(--bio-text-light);">
                                <i class="fas fa-info-circle" style="color: var(--bio-bright-green);"></i>
                                <span style="font-size: 13px;">This message will be sent to BIO-ISAC administrators</span>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="alert-modal-actions">
                    <button class="alert-modal-btn alert-modal-btn-primary" id="sendNewConversationBtn">
                        <i class="fas fa-paper-plane"></i>
                        Send Message
                    </button>
                    <button class="alert-modal-btn alert-modal-btn-outline" id="cancelNewConversationBtn">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <div class="resize-handle resize-handle-vertical" id="sidebar-resize"></div>

        <div class="main-content">
            <div class="content-section" id="content-section">
                <div class="section-title">BioISAC Incident Report</div>
                
                <div class="form-grid bioisac-form">
                    <div class="form-group">
                        <label class="form-label">Incident Type</label>
                        <select class="form-control" id="incidentType">
                            <option value="">Select...</option>
                            <option value="Data Breach">Data Breach</option>
                            <option value="Ransomware / Malware">Ransomware / Malware</option>
                            <option value="Unauthorized Access">Unauthorized Access</option>
                            <option value="Supply Chain Vulnerability">Supply Chain Vulnerability</option>
                            <option value="System Outage / Disruption">System Outage / Disruption</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Assigned To</label>
                        <input type="text" class="form-control" id="assignedTo" placeholder="Enter name...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Severity Level</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" name="severity" id="severity-low" value="Low">
                                <label for="severity-low">Low</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" name="severity" id="severity-moderate" value="Moderate">
                                <label for="severity-moderate">Moderate</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" name="severity" id="severity-high" value="High">
                                <label for="severity-high">High</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" name="severity" id="severity-critical" value="Critical">
                                <label for="severity-critical">Critical</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Was any sensitive data affected?</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" name="sensitiveData" id="sensitive-yes" value="Yes">
                                <label for="sensitive-yes">Yes</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" name="sensitiveData" id="sensitive-no" value="No">
                                <label for="sensitive-no">No</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" name="sensitiveData" id="sensitive-unknown" value="Unknown">
                                <label for="sensitive-unknown">Unknown</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date & Time of Incident</label>
                        <input type="datetime-local" class="form-control" id="incidentDateTime">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Industry</label>
                        <select class="form-control" id="industry">
                            <option value="">Select...</option>
                            <option value="Biotechnology">Biotechnology</option>
                            <option value="Life Sciences">Life Sciences</option>
                            <option value="Research Laboratory">Research Laboratory</option>
                            <option value="Manufacturing / Supply Chain">Manufacturing / Supply Chain</option>
                            <option value="Healthcare / Clinical Data">Healthcare / Clinical Data</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Estimated Impact</label>
                        <div class="checkbox-group estimated-impact-group">
                            <div class="checkbox-item impact-checkbox">
                                <input type="checkbox" id="impact-internal" value="Internal systems only">
                                <label for="impact-internal">Internal systems only</label>
                            </div>
                            <div class="checkbox-item impact-checkbox">
                                <input type="checkbox" id="impact-partners" value="Partners / Vendors affected">
                                <label for="impact-partners">Partners / Vendors affected</label>
                            </div>
                            <div class="checkbox-item impact-checkbox">
                                <input type="checkbox" id="impact-public" value="Public disclosure possible">
                                <label for="impact-public">Public disclosure possible</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Summary</label>
                        <textarea class="textarea bioisac-summary" id="summary" placeholder="Enter summary (2-3 lines max)..." rows="3"></textarea>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-outline" id="resetBtn">Reset</button>
                    <button class="btn btn-primary" id="saveBtn">Save Report</button>
                    <button class="btn btn-primary" id="submitBtn">Submit for Review</button>
                    <button class="btn btn-outline">Link To <i class="fas fa-caret-down"></i></button>
                </div>
            </div>
            <div class="resize-handle resize-handle-horizontal" id="content-resize"></div>

            <div class="incident-queue" id="incident-queue">
                <div class="queue-header">
                    <div>
                        <div class="section-title" style="margin: 0; display: inline;">Reports</div>
                        <div style="font-size: 14px; color: var(--wst-color-text-secondary); margin-top: 5px;">Reports Queue</div>
                    </div>
                    <div class="queue-controls">
                        <span style="font-size: 12px; color: var(--wst-color-text-secondary); margin-right: 10px;">ADVANCED</span>
                        <button><i class="fas fa-search"></i></button>
                        <button><i class="fas fa-filter"></i></button>
                        <button><i class="fas fa-ellipsis-v"></i></button>
                        <button><i class="fas fa-plus"></i></button>
                    </div>
                </div>
                <div class="queue-table-wrapper">
                    <table class="queue-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Actions</th>
                                <th>Title</th>
                                <th>Category</th>
                                <th>Tier</th>
                                <th>Date Observed</th>
                                <th>Created</th>
                                <th>Next Steps</th>
                            </tr>
                        </thead>
                        <tbody id="reportsQueueBody">
                            <tr>
                                <td colspan="8" class="queue-empty">Loading threats...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="queue-footer">
                    <div class="status-legend">
                        <div class="legend-item">
                            <div class="legend-color status-created"></div>
                            <span>Created</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color status-dispatched"></div>
                            <span>Dispatched</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color status-onscene"></div>
                            <span>On Scene</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color status-closed"></div>
                            <span>Closed</span>
                        </div>
                    </div>
                    <div class="pagination">
                        <span class="pagination-info" id="paginationInfo">0 to 0 of 0</span>
                        <button id="refreshQueueBtn" title="Refresh"><i class="fas fa-sync-alt"></i></button>
                        <button><i class="fas fa-angle-double-left"></i></button>
                        <button><i class="fas fa-angle-left"></i></button>
                        <span class="pagination-info">Page 1 of 1</span>
                        <button><i class="fas fa-angle-right"></i></button>
                        <button><i class="fas fa-angle-double-right"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/api-client.js"></script>
    <script>
        // Access control - redirect admins to admin page, unauthenticated users to login
        // Regular users (non-admins) can access this reports dashboard
        (function() {
            const user = apiClient.getCurrentUserSync();
            if (!user) {
                window.location.href = 'index.html';
            } else if (user.role === 'Admin') {
                window.location.href = 'admin.html';
            }
            // Regular users (non-admins) stay on this page - they can access the reports dashboard
        })();
    </script>
    <script>
        // Toast notification function
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // Form data collection
        function collectFormData() {
            const sensitiveData = document.querySelector('input[name="sensitiveData"]:checked');
            const severity = document.querySelector('input[name="severity"]:checked');
            
            // Collect estimated impact from checkboxes
            const estimatedImpact = Array.from(document.querySelectorAll('input[type="checkbox"][id^="impact-"]:checked'))
                .map(checkbox => checkbox.value);
            
            return {
                incidentType: document.getElementById('incidentType').value,
                assignedTo: document.getElementById('assignedTo').value,
                severityLevel: severity ? severity.value : '',
                sensitiveDataAffected: sensitiveData ? sensitiveData.value : '',
                incidentDateTime: document.getElementById('incidentDateTime').value,
                industry: document.getElementById('industry').value,
                estimatedImpact: estimatedImpact,
                summary: document.getElementById('summary').value,
                timestamp: new Date().toISOString()
            };
        }

        // Convert form data to threat submission format
        function convertToThreatSubmission(formData) {
            // Map incident type to category
            const category = formData.incidentType || 'Other';
            
            // Map severity level to impact level
            const impactLevel = formData.severityLevel || 'Unknown';
            
            // Build description from form data
            let description = formData.summary || '';
            if (formData.sensitiveDataAffected) {
                description += `\n\nSensitive Data Affected: ${formData.sensitiveDataAffected}`;
            }
            if (formData.estimatedImpact && formData.estimatedImpact.length > 0) {
                description += `\n\nEstimated Impact: ${formData.estimatedImpact.join(', ')}`;
            }
            if (formData.industry) {
                description += `\n\nIndustry: ${formData.industry}`;
            }
            if (formData.assignedTo) {
                description += `\n\nAssigned To: ${formData.assignedTo}`;
            }
            
            // Parse date/time
            let dateObserved = null;
            if (formData.incidentDateTime) {
                dateObserved = new Date(formData.incidentDateTime);
            }
            
            // Use summary as title, or generate from incident type
            const title = formData.summary 
                ? (formData.summary.length > 100 ? formData.summary.substring(0, 100) + '...' : formData.summary)
                : `${formData.incidentType || 'Incident'} - ${new Date().toLocaleDateString()}`;
            
            return {
                title: title,
                description: description.trim(),
                category: category,
                source: 'Incident Report Form',
                dateObserved: dateObserved,
                impactLevel: impactLevel
            };
        }

        // Reset form
        document.getElementById('resetBtn').addEventListener('click', () => {
            document.getElementById('incidentType').value = '';
            document.getElementById('assignedTo').value = '';
            document.querySelectorAll('input[name="severity"]').forEach(radio => radio.checked = false);
            document.querySelectorAll('input[name="sensitiveData"]').forEach(radio => radio.checked = false);
            document.getElementById('incidentDateTime').value = '';
            document.getElementById('industry').value = '';
            // Reset estimated impact checkboxes
            document.querySelectorAll('input[type="checkbox"][id^="impact-"]').forEach(checkbox => checkbox.checked = false);
            document.getElementById('summary').value = '';
        });

        // Save report (saves as draft - for now, same as submit)
        document.getElementById('saveBtn').addEventListener('click', async () => {
            const formData = collectFormData();
            
            // Validate required fields
            if (!formData.incidentType) {
                showToast('Please select an incident type');
                return;
            }
            if (!formData.summary || formData.summary.trim().length === 0) {
                showToast('Please enter a summary');
                return;
            }
            if (!formData.severityLevel) {
                showToast('Please select a severity level');
                return;
            }
            
            const submitBtn = document.getElementById('saveBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            
            try {
                const threatData = convertToThreatSubmission(formData);
                const response = await apiClient.submitThreat(threatData);
                
                showToast('Report saved successfully. Threat ID: ' + response.id);
                
                // Reset form after successful save
                document.getElementById('resetBtn').click();
            } catch (error) {
                console.error('Error saving report:', error);
                showToast('Error saving report: ' + (error.message || 'Unknown error'));
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });

        // Submit for review
        document.getElementById('submitBtn').addEventListener('click', async () => {
            const formData = collectFormData();
            
            // Validate required fields
            if (!formData.incidentType) {
                showToast('Please select an incident type');
                return;
            }
            if (!formData.summary || formData.summary.trim().length === 0) {
                showToast('Please enter a summary');
                return;
            }
            if (!formData.severityLevel) {
                showToast('Please select a severity level');
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
            
            try {
                const threatData = convertToThreatSubmission(formData);
                const response = await apiClient.submitThreat(threatData);
                
                showToast('Incident report submitted successfully. Threat ID: ' + response.id + '. Pending BioISAC admin review.');
                
                // Reset form after successful submission
                document.getElementById('resetBtn').click();
            } catch (error) {
                console.error('Error submitting report:', error);
                showToast('Error submitting report: ' + (error.message || 'Unknown error'));
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });

        // Message functionality - load from database
        let conversations = {}; // Key: otherUserId, Value: array of messages
        let currentConversationUserId = null;
        let allMessages = [];

        // Load messages from database
        async function loadMessages() {
            try {
                const user = apiClient.getCurrentUserSync();
                if (!user) return;

                allMessages = await apiClient.getMessages();
                
                // Group messages into conversations by the other user
                conversations = {};
                const currentUserId = user.id;
                
                allMessages.forEach(msg => {
                    const otherUserId = msg.fromUserId === currentUserId ? msg.toUserId : msg.fromUserId;
                    const otherUserName = msg.fromUserId === currentUserId ? msg.toUserName : msg.fromUserName;
                    
                    if (!conversations[otherUserId]) {
                        conversations[otherUserId] = {
                            userId: otherUserId,
                            userName: otherUserName || 'Unknown User',
                            messages: [],
                            lastMessage: null,
                            unreadCount: 0
                        };
                    }
                    
                    conversations[otherUserId].messages.push(msg);
                    
                    // Track last message and unread count
                    if (!conversations[otherUserId].lastMessage || 
                        new Date(msg.createdAt) > new Date(conversations[otherUserId].lastMessage.createdAt)) {
                        conversations[otherUserId].lastMessage = msg;
                    }
                    
                    if (!msg.isRead && msg.toUserId === currentUserId) {
                        conversations[otherUserId].unreadCount++;
                    }
                });
                
                // Sort conversations by last message time
                const sortedConversations = Object.values(conversations).sort((a, b) => {
                    if (!a.lastMessage) return 1;
                    if (!b.lastMessage) return -1;
                    return new Date(b.lastMessage.createdAt) - new Date(a.lastMessage.createdAt);
                });
                
                // Render inbox
                renderInbox(sortedConversations);
            } catch (error) {
                console.error('Error loading messages:', error);
                showToast('Error loading messages: ' + error.message);
            }
        }

        function renderInbox(conversationsList) {
            const inboxList = document.getElementById('inboxList');
            inboxList.innerHTML = '';
            
            if (conversationsList.length === 0) {
                inboxList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--bio-text-light); opacity: 0.7;">No messages</div>';
                return;
            }
            
            conversationsList.forEach(conv => {
                const lastMsg = conv.lastMessage;
                const subject = lastMsg?.subject || 'No subject';
                const preview = lastMsg?.body?.substring(0, 50) || '';
                const date = lastMsg ? formatMessageDate(lastMsg.createdAt) : '';
                const isPriority = conv.unreadCount > 0;
                
                const inboxItem = document.createElement('div');
                inboxItem.className = `inbox-item ${isPriority ? 'priority' : ''}`;
                inboxItem.setAttribute('data-user-id', conv.userId);
                inboxItem.setAttribute('data-user-name', conv.userName);
                inboxItem.innerHTML = `
                    <div class="inbox-item-header">
                        <span class="inbox-title">${subject}${preview ? ' - ' + preview + '...' : ''}</span>
                        <span class="inbox-date">${date}</span>
                    </div>
                    <div class="inbox-item-footer">
                        <i class="far fa-comment"></i>
                        <span>${conv.userName}</span>
                        ${conv.unreadCount > 0 ? `<span style="margin-left: auto; background: var(--bio-bright-green); color: var(--bio-primary-green); padding: 2px 6px; border-radius: 10px; font-size: 11px; font-weight: 600;">${conv.unreadCount}</span>` : ''}
                    </div>
                `;
                
                inboxItem.addEventListener('click', () => {
                    showConversation(conv.userId, conv.userName);
                });
                
                inboxList.appendChild(inboxItem);
            });
        }

        function formatMessageDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined });
        }

        // Show conversation view
        async function showConversation(otherUserId, otherUserName) {
            currentConversationUserId = otherUserId;
            document.getElementById('inboxList').style.display = 'none';
            document.getElementById('messageView').style.display = 'flex';
            
            document.getElementById('messageContactName').textContent = otherUserName;
            document.getElementById('messageContactPhone').textContent = '';
            
            const messageContent = document.getElementById('messageContent');
            messageContent.innerHTML = '';
            
            // Get messages for this conversation
            const user = apiClient.getCurrentUserSync();
            const currentUserId = user.id;
            
            const conversationMessages = allMessages.filter(msg => 
                (msg.fromUserId === currentUserId && msg.toUserId === otherUserId) ||
                (msg.fromUserId === otherUserId && msg.toUserId === currentUserId)
            ).sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
            
            // Mark unread messages as read
            for (const msg of conversationMessages) {
                if (!msg.isRead && msg.toUserId === currentUserId) {
                    try {
                        await apiClient.markMessageAsRead(msg.id);
                        msg.isRead = true;
                    } catch (error) {
                        console.error('Error marking message as read:', error);
                    }
                }
            }
            
            // Render messages
            conversationMessages.forEach(msg => {
                const isSent = msg.fromUserId === currentUserId;
                const messageDiv = document.createElement('div');
                messageDiv.className = `message-bubble ${isSent ? 'message-sent' : 'message-received'}`;
                
                const time = new Date(msg.createdAt).toLocaleTimeString('en-US', { 
                    hour: 'numeric', 
                    minute: '2-digit' 
                });
                
                messageDiv.innerHTML = `
                    <div class="message-text">${escapeHtml(msg.body)}</div>
                    <div class="message-time">${time}</div>
                `;
                messageContent.appendChild(messageDiv);
            });
            
            messageContent.scrollTop = messageContent.scrollHeight;
            
            // Reload messages to update unread counts
            await loadMessages();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }


        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text || !currentConversationUserId) return;
            
            const user = apiClient.getCurrentUserSync();
            if (!user) {
                showToast('You must be logged in to send messages');
                return;
        }

            // Get the last message to use its subject, or create a new one
            const conversation = conversations[currentConversationUserId];
            const lastMessage = conversation?.lastMessage;
            const subject = lastMessage?.subject || 'New Message';
            
            try {
                const messageData = {
                    toUserId: currentConversationUserId,
                    subject: subject,
                    body: text
                };
                
                await apiClient.sendMessage(messageData);
                
                // Reload messages to show the new one
                await loadMessages();
                
                // Show the conversation again with updated messages
                await showConversation(currentConversationUserId, conversation?.userName || 'Unknown User');
                
                input.value = '';
            } catch (error) {
                console.error('Error sending message:', error);
                showToast('Error sending message: ' + error.message);
            }
        }
        
        // New Conversation Modal Functions
        function openNewConversationModal() {
            const modal = document.getElementById('newConversationModal');
            if (modal) {
                modal.classList.add('active');
                document.getElementById('newConversationSubject').value = '';
                document.getElementById('newConversationMessage').value = '';
            }
        }

        function closeNewConversationModal() {
            const modal = document.getElementById('newConversationModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        async function sendNewConversation() {
            const subjectEl = document.getElementById('newConversationSubject');
            const messageEl = document.getElementById('newConversationMessage');
            
            if (!subjectEl || !messageEl) {
                showToast('Error: Form elements not found');
                return;
            }
            
            const subject = subjectEl.value.trim();
            const message = messageEl.value.trim();
            
            if (!subject || !message) {
                showToast('Please fill in both subject and message');
                return;
            }
            
            const user = apiClient.getCurrentUserSync();
            if (!user) {
                showToast('You must be logged in to send messages');
                return;
            }
            
            const sendBtn = document.getElementById('sendNewConversationBtn');
            if (!sendBtn) {
                showToast('Error: Send button not found');
                return;
            }
            
            const originalText = sendBtn.innerHTML;
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
            
            try {
                // Send message without toUserId - it will go to admins
                const messageData = {
                    subject: subject,
                    body: message
                };
                
                await apiClient.sendMessage(messageData);
                
                showToast('Message sent successfully!');
                closeNewConversationModal();
                
                // Reload messages to show the new conversation
                await loadMessages();
            } catch (error) {
                console.error('Error sending new conversation:', error);
                const errorMessage = error?.message || error?.toString() || 'Unknown error occurred';
                showToast('Error sending message: ' + errorMessage);
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = originalText;
            }
        }

        // Initialize on page load
        (function init() {
            // Set up event listeners
            const backBtn = document.getElementById('backBtn');
            const sendBtn = document.getElementById('sendBtn');
            const messageInput = document.getElementById('messageInput');
            const plusBtn = document.querySelector('.plus-btn');
            
            if (backBtn) {
                backBtn.addEventListener('click', () => {
            document.getElementById('inboxList').style.display = 'block';
            document.getElementById('messageView').style.display = 'none';
                    currentConversationUserId = null;
        });
            }
            
            if (sendBtn) {
                sendBtn.addEventListener('click', sendMessage);
            }
            
            if (messageInput) {
                messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
            }
            
            // New conversation button
            if (plusBtn) {
                plusBtn.addEventListener('click', openNewConversationModal);
            }
            
            // New conversation modal handlers
            const closeNewConversationBtn = document.getElementById('closeNewConversationModal');
            const cancelNewConversationBtn = document.getElementById('cancelNewConversationBtn');
            const sendNewConversationBtn = document.getElementById('sendNewConversationBtn');
            const newConversationModal = document.getElementById('newConversationModal');
            
            if (closeNewConversationBtn) {
                closeNewConversationBtn.addEventListener('click', closeNewConversationModal);
            }
            
            if (cancelNewConversationBtn) {
                cancelNewConversationBtn.addEventListener('click', closeNewConversationModal);
            }
            
            if (sendNewConversationBtn) {
                sendNewConversationBtn.addEventListener('click', sendNewConversation);
            }
            
            // Close modal when clicking outside
            if (newConversationModal) {
                newConversationModal.addEventListener('click', function(e) {
                    if (e.target === newConversationModal) {
                        closeNewConversationModal();
                    }
                });
            }
            
            // Close modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && newConversationModal && newConversationModal.classList.contains('active')) {
                    closeNewConversationModal();
                }
            });
            
            // Load messages
            loadMessages();
        })();

        // Settings Dropdown Functionality
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsDropdown = document.getElementById('settingsDropdown');
        const accountSettingsMenuItem = document.getElementById('accountSettingsMenuItem');
        const settingsContainer = document.querySelector('.settings-container');

        // Toggle settings dropdown
        if (settingsBtn && settingsDropdown) {
            settingsBtn.addEventListener('click', function (e) {
                e.stopPropagation();
                settingsDropdown.classList.toggle('active');
            });
            
            // Close dropdown when clicking outside
            if (settingsContainer) {
                document.addEventListener('click', function (e) {
                    if (!settingsContainer.contains(e.target)) {
                        settingsDropdown.classList.remove('active');
                    }
                });
            }

            // Open account settings modal
            if (accountSettingsMenuItem) {
                accountSettingsMenuItem.addEventListener('click', async function () {
                    settingsDropdown.classList.remove('active');
                    await openAccountSettingsModal();
                });
            }
        }

        // Logout button
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async function() {
                try {
                    await apiClient.logout();
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error('Error logging out:', error);
                    // Still redirect even if logout API call fails
                    window.location.href = 'index.html';
            }
            });
        }

        // Account Settings Modal Functions
        async function openAccountSettingsModal() {
            const modal = document.getElementById('accountSettingsModal');
            if (!modal) return;

            try {
                // Load user profile
                const profile = await apiClient.getProfile();
                
                // Populate profile fields
                document.getElementById('accountFullName').textContent = profile.fullName || '';
                document.getElementById('accountEmail').textContent = profile.email || '';
                document.getElementById('accountFacilityName').textContent = profile.facilityName || '';
                document.getElementById('accountFacilityType').value = profile.facilityType || 'Hospital';
            
                // Load notification preferences
                const preferences = await apiClient.getNotificationPreferences();
                
                document.getElementById('notificationDeliveryMode').value = preferences.deliveryMode || 'Immediate';
                document.getElementById('receiveHighTier').checked = preferences.receiveHighTier !== false;
                document.getElementById('receiveMediumTier').checked = preferences.receiveMediumTier !== false;
                document.getElementById('receiveLowTier').checked = preferences.receiveLowTier === true;
                
                if (preferences.dailyDigestTime) {
                    document.getElementById('dailyDigestTime').value = preferences.dailyDigestTime;
                }
                if (preferences.weeklyDigestDay) {
                    document.getElementById('weeklyDigestDay').value = preferences.weeklyDigestDay;
                }
                
                // Show/hide digest fields based on delivery mode
                updateDigestFields();
                
                // Show modal
                modal.classList.add('active');
            } catch (error) {
                console.error('Error loading account settings:', error);
                showToast('Error loading account settings: ' + error.message);
            }
        }

        function updateDigestFields() {
            const deliveryMode = document.getElementById('notificationDeliveryMode')?.value;
            const dailyField = document.getElementById('dailyDigestTimeField');
            const weeklyField = document.getElementById('weeklyDigestDayField');
            
            if (deliveryMode === 'DailyDigest') {
                if (dailyField) dailyField.style.display = 'block';
                if (weeklyField) weeklyField.style.display = 'none';
            } else if (deliveryMode === 'WeeklyDigest') {
                if (dailyField) dailyField.style.display = 'none';
                if (weeklyField) weeklyField.style.display = 'block';
            } else {
                if (dailyField) dailyField.style.display = 'none';
                if (weeklyField) weeklyField.style.display = 'none';
            }
        }

        // Delivery mode change handler
        const deliveryModeSelect = document.getElementById('notificationDeliveryMode');
        if (deliveryModeSelect) {
            deliveryModeSelect.addEventListener('change', updateDigestFields);
        }

        // Close modal handlers
        const closeAccountSettingsBtn = document.getElementById('closeAccountSettingsModal');
        if (closeAccountSettingsBtn) {
            closeAccountSettingsBtn.addEventListener('click', function() {
                const modal = document.getElementById('accountSettingsModal');
                if (modal) modal.classList.remove('active');
            });
        }

        const cancelAccountSettingsBtn = document.getElementById('cancelAccountSettingsBtn');
        if (cancelAccountSettingsBtn) {
            cancelAccountSettingsBtn.addEventListener('click', function() {
                const modal = document.getElementById('accountSettingsModal');
                if (modal) modal.classList.remove('active');
            });
        }

        // Save account settings
        const saveAccountSettingsBtn = document.getElementById('saveAccountSettingsBtn');
        if (saveAccountSettingsBtn) {
            saveAccountSettingsBtn.addEventListener('click', async function() {
                const btn = this;
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

                try {
                    // Update profile (facility type)
                    const facilityType = document.getElementById('accountFacilityType')?.value;
                    const profile = await apiClient.getProfile();
                    
                    await apiClient.updateProfile({
                        fullName: profile.fullName,
                        facilityName: profile.facilityName,
                        facilityType: facilityType
                    });

                    // Update notification preferences
                    const deliveryMode = document.getElementById('notificationDeliveryMode')?.value;
                    const preferences = {
                        deliveryMode: deliveryMode,
                        receiveHighTier: document.getElementById('receiveHighTier')?.checked || false,
                        receiveMediumTier: document.getElementById('receiveMediumTier')?.checked || false,
                        receiveLowTier: document.getElementById('receiveLowTier')?.checked || false
                    };

                    if (deliveryMode === 'DailyDigest') {
                        preferences.dailyDigestTime = document.getElementById('dailyDigestTime')?.value;
                    }
                    if (deliveryMode === 'WeeklyDigest') {
                        preferences.weeklyDigestDay = document.getElementById('weeklyDigestDay')?.value;
                    }

                    await apiClient.updateNotificationPreferences(preferences);

                    showToast('Account settings saved successfully!');
                    const modal = document.getElementById('accountSettingsModal');
                    if (modal) modal.classList.remove('active');
                } catch (error) {
                    console.error('Error saving account settings:', error);
                    showToast('Error saving account settings: ' + error.message);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            });
        }

        // Sidebar resize functionality
        const sidebar = document.getElementById('sidebar');
        const sidebarResize = document.getElementById('sidebar-resize');
        let isResizingSidebar = false;
        let startX = 0;
        let startWidth = 0;

        sidebarResize.addEventListener('mousedown', (e) => {
            isResizingSidebar = true;
            startX = e.clientX;
            startWidth = sidebar.offsetWidth;
            document.addEventListener('mousemove', handleSidebarResize);
            document.addEventListener('mouseup', stopSidebarResize);
            e.preventDefault();
        });

        function handleSidebarResize(e) {
            if (!isResizingSidebar) return;
            const diff = e.clientX - startX;
            const newWidth = Math.max(200, Math.min(600, startWidth + diff));
            sidebar.style.width = newWidth + 'px';
        }

        function stopSidebarResize() {
            isResizingSidebar = false;
            document.removeEventListener('mousemove', handleSidebarResize);
            document.removeEventListener('mouseup', stopSidebarResize);
        }

        // Content section resize functionality
        const contentSection = document.getElementById('content-section');
        const incidentQueue = document.getElementById('incident-queue');
        const contentResize = document.getElementById('content-resize');
        let isResizingContent = false;
        let startY = 0;
        let startHeight = 0;

        contentResize.addEventListener('mousedown', (e) => {
            isResizingContent = true;
            startY = e.clientY;
            startHeight = contentSection.offsetHeight;
            document.addEventListener('mousemove', handleContentResize);
            document.addEventListener('mouseup', stopContentResize);
            e.preventDefault();
        });

        function handleContentResize(e) {
            if (!isResizingContent) return;
            const diff = e.clientY - startY;
            const newHeight = Math.max(300, startHeight + diff);
            contentSection.style.height = newHeight + 'px';
            contentSection.style.flexShrink = '0';
        }

        function stopContentResize() {
            isResizingContent = false;
            document.removeEventListener('mousemove', handleContentResize);
            document.removeEventListener('mouseup', stopContentResize);
        }

        // Reports Queue Functionality
        let currentThreats = [];

        async function loadReportsQueue() {
            const tbody = document.getElementById('reportsQueueBody');
            if (!tbody) return;

            try {
                tbody.innerHTML = '<tr><td colspan="8" class="queue-empty">Loading threats...</td></tr>';
                
                const alerts = await apiClient.getUserAlerts();
                currentThreats = alerts || [];
                
                if (currentThreats.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="queue-empty">No threats assigned to your industry</td></tr>';
                    updatePaginationInfo(0);
                    return;
                }

                tbody.innerHTML = '';
                currentThreats.forEach((threat, index) => {
                    const row = document.createElement('tr');
                    row.setAttribute('data-threat-id', threat.id);
                    
                    const tier = threat.tier || 'Unknown';
                    const tierClass = tier.toLowerCase() === 'high' ? 'tier-high' : 
                                    tier.toLowerCase() === 'medium' ? 'tier-medium' : 'tier-low';
                    
                    const dateObserved = threat.dateObserved ? new Date(threat.dateObserved).toLocaleDateString() : 'N/A';
                    const createdAt = threat.createdAt ? new Date(threat.createdAt).toLocaleDateString() : 'N/A';
                    const hasNextSteps = threat.nextSteps && threat.nextSteps.length > 0;
                    
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>
                            <button class="icon-btn-small" onclick="viewThreatDetails(${threat.id})" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                        <td title="${escapeHtml(threat.title)}">${truncateText(threat.title, 30)}</td>
                        <td>${escapeHtml(threat.category || 'N/A')}</td>
                        <td><span class="tier-badge ${tierClass}">${tier}</span></td>
                        <td>${dateObserved}</td>
                        <td>${createdAt}</td>
                        <td>
                            ${hasNextSteps ? 
                                `<button class="btn btn-outline" style="padding: 4px 8px; font-size: 12px;" onclick="viewNextSteps(${threat.id}, event)">
                                    <i class="fas fa-list-check"></i> View Steps
                                </button>` : 
                                '<span style="opacity: 0.5;">No steps</span>'
                            }
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });

                updatePaginationInfo(currentThreats.length);
            } catch (error) {
                console.error('Error loading reports queue:', error);
                tbody.innerHTML = '<tr><td colspan="8" class="queue-empty">Error loading threats: ' + escapeHtml(error.message) + '</td></tr>';
                showToast('Error loading threats: ' + error.message);
            }
        }

        function updatePaginationInfo(total) {
            const paginationInfo = document.getElementById('paginationInfo');
            if (paginationInfo) {
                paginationInfo.textContent = `1 to ${total} of ${total}`;
            }
        }

        function truncateText(text, maxLength) {
            if (!text) return 'N/A';
            if (text.length <= maxLength) return escapeHtml(text);
            return escapeHtml(text.substring(0, maxLength)) + '...';
        }

        function viewThreatDetails(threatId) {
            const threat = currentThreats.find(t => t.id === threatId);
            if (!threat) {
                showToast('Threat not found');
                return;
            }
            
            // Show next steps modal with full threat details
            viewNextSteps(threatId, null);
        }

        function viewNextSteps(threatId, event) {
            if (event) {
                event.stopPropagation();
            }
            
            const threat = currentThreats.find(t => t.id === threatId);
            if (!threat) {
                showToast('Threat not found');
                return;
            }

            const modal = document.getElementById('nextStepsModal');
            if (!modal) return;

            document.getElementById('nextStepsThreatTitle').textContent = threat.title || 'Unknown Threat';
            
            const descriptionDiv = document.getElementById('nextStepsDescription');
            const descriptionField = document.getElementById('threatDescriptionField');
            if (threat.description) {
                descriptionDiv.textContent = threat.description;
                descriptionField.style.display = 'block';
            } else {
                descriptionField.style.display = 'none';
            }
            
            const nextStepsList = document.getElementById('nextStepsList');
            const noNextSteps = document.getElementById('noNextSteps');
            
            if (threat.nextSteps && threat.nextSteps.length > 0) {
                nextStepsList.innerHTML = threat.nextSteps.map(step => `<li>${escapeHtml(step)}</li>`).join('');
                nextStepsList.style.display = 'block';
                noNextSteps.style.display = 'none';
            } else {
                nextStepsList.style.display = 'none';
                noNextSteps.style.display = 'block';
            }

            const reasoningField = document.getElementById('aiReasoningField');
            const reasoningDiv = document.getElementById('nextStepsReasoning');
            if (threat.aiReasoning) {
                reasoningDiv.textContent = threat.aiReasoning;
                reasoningField.style.display = 'block';
            } else {
                reasoningField.style.display = 'none';
            }

            // Store threat ID in modal for "Mark as Completed" functionality
            modal.dataset.threatId = threatId;
            modal.dataset.threatTitle = threat.title || 'Unknown Threat';
            
            // Show/hide "Mark as Completed" button based on whether there are next steps
            const markBtn = document.getElementById('markCompletedBtn');
            if (markBtn) {
                if (threat.nextSteps && threat.nextSteps.length > 0) {
                    markBtn.style.display = 'inline-flex';
                } else {
                    markBtn.style.display = 'none';
                }
            }

            modal.classList.add('active');
        }
        
        // Handle "Mark as Completed" button
        async function markNextStepsCompleted() {
            const modal = document.getElementById('nextStepsModal');
            if (!modal) return;
            
            const threatId = modal.dataset.threatId;
            const threatTitle = modal.dataset.threatTitle || 'Unknown Threat';
            
            if (!threatId) {
                showToast('Error: Threat ID not found');
                return;
            }
            
            const markBtn = document.getElementById('markCompletedBtn');
            if (!markBtn) return;
            
            // Disable button and show loading state
            const originalText = markBtn.innerHTML;
            markBtn.disabled = true;
            markBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
            
            try {
                // Get current user
                const user = apiClient.getCurrentUserSync();
                if (!user) {
                    showToast('You must be logged in to mark steps as completed');
                    markBtn.disabled = false;
                    markBtn.innerHTML = originalText;
                    return;
                }
                
                // Create message to admin
                const messageBody = `I have completed the recommended next steps for the following threat:\n\n` +
                    `Threat ID: #${String(threatId).padStart(5, '0')}\n` +
                    `Threat Title: ${threatTitle}\n\n` +
                    `All recommended actions have been completed.`;
                
                await apiClient.sendMessage({
                    subject: `Next Steps Completed - Threat #${String(threatId).padStart(5, '0')}`,
                    body: messageBody,
                    threatId: parseInt(threatId)
                });
                
                showToast('Admin has been notified that next steps are completed');
                
                // Close modal after a short delay
                setTimeout(() => {
                    modal.classList.remove('active');
                }, 1500);
                
            } catch (error) {
                console.error('Error marking steps as completed:', error);
                showToast('Error sending notification: ' + (error.message || 'Unknown error'));
                markBtn.disabled = false;
                markBtn.innerHTML = originalText;
            }
        }
        
        // Setup "Mark as Completed" button handler
        function setupMarkCompletedButton() {
            const markBtn = document.getElementById('markCompletedBtn');
            if (markBtn) {
                markBtn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    markNextStepsCompleted();
                };
            }
        }

        // Close next steps modal - define this first so it's available
        // Close next steps modal - setup once with flag to prevent duplicates
        let nextStepsModalCloseSetup = false;
        function setupNextStepsModalClose() {
            if (nextStepsModalCloseSetup) return; // Prevent duplicate setup
            nextStepsModalCloseSetup = true;
            
            const nextStepsModal = document.getElementById('nextStepsModal');
            const closeNextStepsBtn = document.getElementById('closeNextStepsBtn');
            const closeNextStepsModal = document.getElementById('closeNextStepsModal');
            
            if (!nextStepsModal) {
                nextStepsModalCloseSetup = false; // Reset if modal not found
                return;
            }
            
            function closeNextStepsModalFunc(e) {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                if (nextStepsModal) {
                    nextStepsModal.classList.remove('active');
                }
            }
            
            // Close button in header - use onclick to ensure it works
            if (closeNextStepsModal) {
                closeNextStepsModal.onclick = closeNextStepsModalFunc;
            }
            
            // Close button in footer - use onclick to ensure it works
            if (closeNextStepsBtn) {
                closeNextStepsBtn.onclick = closeNextStepsModalFunc;
            }
            
            // Close modal when clicking outside (on the backdrop)
            nextStepsModal.onclick = function(e) {
                if (e.target === nextStepsModal) {
                    closeNextStepsModalFunc(e);
                }
            };
            
            // Prevent clicks inside modal content from closing the modal
            const modalContent = nextStepsModal.querySelector('.next-steps-modal-content');
            if (modalContent) {
                modalContent.onclick = function(e) {
                    e.stopPropagation();
                };
            }
            
            // Close modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && nextStepsModal && nextStepsModal.classList.contains('active')) {
                    closeNextStepsModalFunc(e);
                }
            });
        }
        
        // Setup close handlers and mark completed button when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setupNextStepsModalClose();
                setupMarkCompletedButton();
            });
        } else {
            setupNextStepsModalClose();
            setupMarkCompletedButton();
        }

        // Refresh queue button
        const refreshQueueBtn = document.getElementById('refreshQueueBtn');
        if (refreshQueueBtn) {
            refreshQueueBtn.addEventListener('click', () => {
                loadReportsQueue();
            });
        }

        // Load reports queue on page load
        (function() {
            loadReportsQueue();
        })();
    </script>

    <!-- Next Steps Modal -->
    <div class="next-steps-modal" id="nextStepsModal">
        <div class="next-steps-modal-content">
            <div class="alert-modal-header">
                <h2><i class="fas fa-list-check"></i> Next Steps</h2>
                <button class="alert-modal-close" id="closeNextStepsModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="alert-modal-body">
                <div class="alert-modal-field">
                    <label class="alert-modal-label">Threat Title</label>
                    <div class="alert-modal-value readonly" id="nextStepsThreatTitle"></div>
                </div>
                <div class="alert-modal-field" id="threatDescriptionField">
                    <label class="alert-modal-label">Description</label>
                    <div class="alert-modal-value readonly" id="nextStepsDescription" style="white-space: pre-wrap;"></div>
                </div>
                <div class="alert-modal-field">
                    <label class="alert-modal-label">Recommended Actions</label>
                    <ul class="next-steps-list" id="nextStepsList"></ul>
                    <div id="noNextSteps" style="display: none; color: var(--bio-text-light); opacity: 0.7; padding: 15px;">
                        No next steps available for this threat.
                    </div>
                </div>
                <div class="alert-modal-field" id="aiReasoningField" style="display: none;">
                    <label class="alert-modal-label">AI Reasoning</label>
                    <div class="alert-modal-value readonly" id="nextStepsReasoning" style="white-space: pre-wrap;"></div>
                </div>
            </div>
            <div class="alert-modal-actions">
                <button class="alert-modal-btn alert-modal-btn-primary" id="markCompletedBtn">
                    <i class="fas fa-check-circle"></i>
                    Mark as Completed
                </button>
                <button class="alert-modal-btn alert-modal-btn-outline" id="closeNextStepsBtn">
                    <i class="fas fa-times"></i>
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Accessibility Modal -->
    <div class="accessibility-modal" id="accessibilityModal">
        <div class="accessibility-modal-content">
            <div class="accessibility-modal-header">
                <h2 class="accessibility-modal-title">
                    <i class="fas fa-universal-access"></i>
                    Accessibility Settings
                </h2>
                <button class="accessibility-modal-close" id="accessibilityModalClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="accessibility-options">
                <div class="accessibility-option" data-mode="normal">
                    <input type="radio" name="colorblindMode" id="modeNormal" value="normal" checked>
                    <label for="modeNormal" class="accessibility-option-label">
                        <div>Normal Vision</div>
                        <div class="accessibility-option-description">Default color scheme</div>
                    </label>
                </div>
                <div class="accessibility-option" data-mode="protanopia">
                    <input type="radio" name="colorblindMode" id="modeProtanopia" value="protanopia">
                    <label for="modeProtanopia" class="accessibility-option-label">
                        <div>Protanopia</div>
                        <div class="accessibility-option-description">Red-blind (red-green colorblindness)</div>
                    </label>
                </div>
                <div class="accessibility-option" data-mode="deuteranopia">
                    <input type="radio" name="colorblindMode" id="modeDeuteranopia" value="deuteranopia">
                    <label for="modeDeuteranopia" class="accessibility-option-label">
                        <div>Deuteranopia</div>
                        <div class="accessibility-option-description">Green-blind (red-green colorblindness)</div>
                    </label>
                </div>
                <div class="accessibility-option" data-mode="tritanopia">
                    <input type="radio" name="colorblindMode" id="modeTritanopia" value="tritanopia">
                    <label for="modeTritanopia" class="accessibility-option-label">
                        <div>Tritanopia</div>
                        <div class="accessibility-option-description">Blue-blind (blue-yellow colorblindness)</div>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/accessibility.js"></script>
</body>
</html>

